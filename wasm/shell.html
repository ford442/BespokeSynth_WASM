<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BespokeSynth WASM - WebGPU Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #1a1a1e;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            color: #e0e0e5;
        }
        
        #container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        #header {
            height: 40px;
            background: #252528;
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid #3a3a40;
        }
        
        #header h1 {
            font-size: 16px;
            font-weight: 500;
            color: #e0e0e5;
        }
        
        #header .version {
            margin-left: 12px;
            font-size: 12px;
            color: #888;
        }
        
        #header .controls {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }
        
        #header button {
            background: #3a3a40;
            border: none;
            color: #e0e0e5;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        
        #header button:hover {
            background: #4a4a50;
        }
        
        #header button.primary {
            background: #4080c0;
        }
        
        #header button.primary:hover {
            background: #5090d0;
        }
        
        #header button.danger {
            background: #c04040;
        }
        
        #header button.danger:hover {
            background: #d05050;
        }
        
        #canvas-container {
            flex: 1;
            position: relative;
        }
        
        #canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }
        
        #loading .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #3a3a40;
            border-top-color: #4080c0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #loading .message {
            font-size: 14px;
            color: #888;
        }
        
        #loading.hidden {
            display: none;
        }
        
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            max-width: 500px;
            padding: 32px;
            background: #2a2020;
            border: 1px solid #c04040;
            border-radius: 8px;
            display: none;
        }
        
        #error.visible {
            display: block;
        }
        
        #error h2 {
            color: #ff6060;
            margin-bottom: 16px;
        }
        
        #error p {
            color: #ccc;
            line-height: 1.5;
        }
        
        #status {
            position: absolute;
            bottom: 8px;
            right: 8px;
            font-size: 11px;
            color: #666;
            background: rgba(0, 0, 0, 0.5);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        /* Panel status display */
        #panel-status {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 11px;
            color: #aaa;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #3a3a40;
            max-width: 250px;
        }
        
        #panel-status .status-title {
            font-weight: bold;
            color: #4080c0;
            margin-bottom: 6px;
        }
        
        #panel-status .panel-item {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            padding: 2px 0;
        }
        
        #panel-status .panel-name {
            color: #ccc;
        }
        
        #panel-status .panel-indicator {
            font-size: 10px;
        }
        
        #panel-status .panel-indicator.loaded {
            color: #4080c0;
        }
        
        #panel-status .panel-indicator.running {
            color: #40c080;
        }
        
        /* WebGPU not supported message */
        #webgpu-check {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            max-width: 500px;
            padding: 32px;
            background: #202030;
            border: 1px solid #4060a0;
            border-radius: 8px;
            display: none;
        }
        
        #webgpu-check.visible {
            display: block;
        }
        
        #webgpu-check h2 {
            color: #6090d0;
            margin-bottom: 16px;
        }
        
        #webgpu-check ul {
            text-align: left;
            margin: 16px 0;
            padding-left: 24px;
        }
        
        #webgpu-check li {
            margin: 8px 0;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div id="container">
        <header id="header">
            <h1>BespokeSynth</h1>
            <span class="version" id="version-text">WASM</span>
            <div class="controls">
                <button id="btn-play" class="primary">▶ Play</button>
                <button id="btn-stop" class="danger">⏹ Stop</button>
            </div>
        </header>
        
        <div id="canvas-container">
            <canvas id="canvas"></canvas>
            
            <div id="loading">
                <div class="spinner"></div>
                <div class="message" id="loading-message">Loading BespokeSynth...</div>
            </div>
            
            <div id="webgpu-check">
                <h2>WebGPU Required</h2>
                <p>BespokeSynth WASM requires WebGPU, which is not available in your browser.</p>
                <ul>
                    <li>Chrome 113+ with WebGPU enabled</li>
                    <li>Edge 113+ with WebGPU enabled</li>
                    <li>Firefox Nightly with WebGPU enabled</li>
                </ul>
                <p>Please update your browser or enable WebGPU in flags.</p>
            </div>
            
            <div id="error">
                <h2>Error</h2>
                <p id="error-message"></p>
            </div>
            
            <!-- Panel status display -->
            <div id="panel-status" style="display: none;">
                <div class="status-title">Panel Status</div>
                <div id="panel-status-content"></div>
            </div>
            
            <!-- Default JS handler for async WASM initialization -->
            <script>
            (function() {
                // Helpers
                const loadingEl = document.getElementById('loading');
                const loadingMessageEl = document.getElementById('loading-message');
                const errorEl = document.getElementById('error');
                const errorMsgEl = document.getElementById('error-message');
                const webgpuEl = document.getElementById('webgpu-check');
                let initTimeout = null;

                function showStatus(msg) {
                    if (loadingMessageEl) loadingMessageEl.textContent = msg;
                }

                function showError(message) {
                    if (loadingEl) loadingEl.classList.add('hidden');
                    if (webgpuEl) webgpuEl.classList.remove('visible');
                    if (errorMsgEl) errorMsgEl.textContent = message;
                    if (errorEl) errorEl.classList.add('visible');
                    console.error('BespokeSynth Init Error:', message);
                }

                function showWebGPUCheck() {
                    if (loadingEl) loadingEl.classList.add('hidden');
                    if (errorEl) errorEl.classList.remove('visible');
                    if (webgpuEl) webgpuEl.classList.add('visible');
                    console.warn('BespokeSynth: WebGPU unavailable or failed to initialize');
                }

                // Default callback used by C++ to signal completion
                window.__bespoke_on_init_complete = function(status) {
                    console.log('Window callback __bespoke_on_init_complete invoked with status', status);
                    if (initTimeout) { clearTimeout(initTimeout); initTimeout = null; }

                    if (status === 0) {
                        // Success
                        if (loadingEl) loadingEl.classList.add('hidden');
                        if (webgpuEl) webgpuEl.classList.remove('visible');
                        if (errorEl) errorEl.classList.remove('visible');
                        console.log('BespokeSynth WASM initialization succeeded');
                        
                        // Log final state
                        if (Module._bespoke_get_init_state) {
                            const initState = Module._bespoke_get_init_state();
                            console.log('Final init state:', initState);
                        }
                        return;
                    }

                    // Negative codes indicate failures from native side
                    if (status === -1) {
                        showWebGPUCheck();
                    } else if (status === -2) {
                        showError('Renderer initialization failed. See console for details.');
                    } else if (status === -3) {
                        showError('Audio backend failed to initialize. Check permissions and browser audio settings.');
                    } else {
                        showError('Initialization failed with code: ' + status);
                    }
                    
                    // Log error message if available
                    if (Module._bespoke_get_init_error) {
                        const errorMsg = Module.ccall('bespoke_get_init_error', 'string', [], []);
                        if (errorMsg) {
                            console.error('Init error details:', errorMsg);
                        }
                    }
                };

                function attemptAutoInit() {
                    // If Emscripten Module exists and exposes the init symbol, call it
                    try {
                        if (typeof Module !== 'undefined' && typeof Module._bespoke_init === 'function') {
                            const canvas = document.getElementById('canvas');
                            const w = canvas ? canvas.clientWidth : window.innerWidth;
                            const h = canvas ? canvas.clientHeight : window.innerHeight;
                            console.log('Auto-calling Module._bespoke_init with', w, h);
                            Module._bespoke_init(w, h, 44100, 512);

                            // Set a fallback timeout in case init callback never fires
                            initTimeout = setTimeout(() => {
                                console.error('BespokeSynth init timed out waiting for __bespoke_on_init_complete');
                                showError('Initialization timed out — WebGPU may be blocked or unsupported.');
                            }, 12000);
                        }
                    } catch (e) {
                        console.error('Error while auto-initializing BespokeSynth:', e);
                    }
                }

                // If Module is already present and calledRun is true, try to init
                if (typeof Module !== 'undefined') {
                    if (Module.calledRun) {
                        attemptAutoInit();
                    } else {
                        const prev = Module.onRuntimeInitialized;
                        Module.onRuntimeInitialized = function() {
                            try { if (typeof prev === 'function') prev(); } catch (e) {}
                            attemptAutoInit();
                        };
                    }
                } else {
                    // If Module is not yet defined, try again after DOM ready
                    document.addEventListener('DOMContentLoaded', () => {
                        setTimeout(() => attemptAutoInit(), 0);
                    });
                }
            })();
            </script>

            <div id="status"></div>
        </div>
    </div>
    
    <script>
        // Check WebGPU support
        async function checkWebGPU() {
            if (!navigator.gpu) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('webgpu-check').classList.add('visible');
                return false;
            }
            
            try {
                const adapter = await navigator.gpu.requestAdapter();
                if (!adapter) {
                    throw new Error('No WebGPU adapter found');
                }
                return true;
            } catch (e) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('webgpu-check').classList.add('visible');
                return false;
            }
        }
        
        // Update loading message
        function updateLoadingMessage(message) {
            document.getElementById('loading-message').textContent = message;
        }
        
        // Show error
        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error-message').textContent = message;
            document.getElementById('error').classList.add('visible');
        }
        
        // Module loaded callback
        var Module = {
            preRun: [],
            postRun: [],
            
            print: function(text) {
                console.log(text);
            },
            
            printErr: function(text) {
                console.error(text);
            },
            
            canvas: (function() {
                var canvas = document.getElementById('canvas');
                return canvas;
            })(),
            
            setStatus: function(text) {
                if (text) {
                    updateLoadingMessage(text);
                }
            },
            
            onRuntimeInitialized: function() {
                document.getElementById('loading').classList.add('hidden');
                
                // Update version
                if (Module._bespoke_get_version) {
                    var version = Module.ccall('bespoke_get_version', 'string', [], []);
                    document.getElementById('version-text').textContent = version;
                }
                
                console.log('BespokeSynth WASM initialized');
            }
        };
        
        // Button handlers
        document.getElementById('btn-play').addEventListener('click', function() {
            if (Module._bespoke_play) {
                Module._bespoke_play();
            }
        });
        
        document.getElementById('btn-stop').addEventListener('click', function() {
            if (Module._bespoke_stop) {
                Module._bespoke_stop();
            }
        });
        
        // Resize canvas to container
        function resizeCanvas() {
            var container = document.getElementById('canvas-container');
            var canvas = document.getElementById('canvas');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        
        // Panel status update loop
        function updatePanelStatus() {
            // Check if panel status functions are available
            if (Module._bespoke_get_panel_count && 
                Module._bespoke_get_panel_name &&
                Module._bespoke_is_panel_loaded &&
                Module._bespoke_is_panel_running &&
                Module._bespoke_get_panel_frame_count) {
                
                var panelStatusEl = document.getElementById('panel-status');
                var panelStatusContent = document.getElementById('panel-status-content');
                
                if (panelStatusEl && panelStatusContent) {
                    // Show the panel status display
                    panelStatusEl.style.display = 'block';
                    
                    var panelCount = Module._bespoke_get_panel_count();
                    var html = '';
                    
                    for (var i = 0; i < panelCount; i++) {
                        var name = Module.ccall('bespoke_get_panel_name', 'string', ['number'], [i]);
                        var loaded = Module._bespoke_is_panel_loaded(i);
                        var running = Module._bespoke_is_panel_running(i);
                        var frameCount = Module._bespoke_get_panel_frame_count(i);
                        
                        var statusText = '';
                        var statusClass = '';
                        
                        if (running) {
                            statusText = `✓ Running (${frameCount} frames)`;
                            statusClass = 'running';
                        } else if (loaded) {
                            statusText = '● Loaded';
                            statusClass = 'loaded';
                        } else {
                            statusText = '○ Not Loaded';
                            statusClass = '';
                        }
                        
                        html += `<div class="panel-item">
                            <span class="panel-name">${name}:</span>
                            <span class="panel-indicator ${statusClass}">${statusText}</span>
                        </div>`;
                    }
                    
                    panelStatusContent.innerHTML = html;
                }
            }
        }
        
        // Status update loop
        function updateStatus() {
            if (Module._bespoke_get_sample_rate && Module._bespoke_get_buffer_size) {
                var sampleRate = Module._bespoke_get_sample_rate();
                var bufferSize = Module._bespoke_get_buffer_size();
                var cpuLoad = Module._bespoke_get_cpu_load ? Module._bespoke_get_cpu_load() : 0;
                
                document.getElementById('status').textContent = 
                    `${sampleRate} Hz | ${bufferSize} samples | CPU: ${(cpuLoad * 100).toFixed(1)}%`;
            }
            
            // Update panel status
            updatePanelStatus();
        }
        
        setInterval(updateStatus, 500);
        
        // Log all panel status when clicking on panel status display
        document.addEventListener('click', function(e) {
            if (e.target.closest('#panel-status')) {
                if (Module._bespoke_log_all_panels_status) {
                    console.log('=== Requesting Panel Status Dump ===');
                    Module._bespoke_log_all_panels_status();
                }
            }
        });
        
        // Start initialization
        async function init() {
            updateLoadingMessage('Checking WebGPU support...');
            
            if (!await checkWebGPU()) {
                return;
            }
            
            updateLoadingMessage('Loading WebAssembly module...');
        }
        
        init();
    </script>
    
    {{{ SCRIPT }}}
</body>
</html>
